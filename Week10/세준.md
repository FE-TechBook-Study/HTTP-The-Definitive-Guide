# 15장 엔터티와 인코딩

HTTP의 보장 사항:

- 객체는 올바르게 **식별** (Content-Type, Content-Language)
- 객체는 올바르게 **압축 해제** (Content-Encoding, Content-Length)
- 객체는 항상 **최신 상태 유지** (검사기, 캐시 만료)
- 사용자 요구 충족 (Accept, Range, Delta)
- 네트워크 효율성 (압축, 범위 요청, 델타 인코딩)
- 조작되지 않은 **무결성 보장** (Content-MD5, 전송 인코딩)

---

## 15.1 메시지와 엔터티

- **HTTP 메시지**: 운송을 위한 컨테이너
- **HTTP 엔터티**: 실제 화물(데이터)

### 주요 엔터티 헤더

- **Content-Type**: 데이터의 MIME 타입
- **Content-Length**: 본문 크기(byte 단위)
- **Content-Language**: 자연어(ko, en 등)
- **Content-Encoding**: 압축/암호화 방식
- **Content-Location**: 리소스의 다른 위치
- **Content-Range**: 전체 중 일부 범위
- **Content-MD5**: 무결성 체크섬
- **Last-Modified**: 최종 수정일
- **Expires**: 만료 시각
- **Allow**: 리소스에서 허용되는 HTTP 메서드

---

## 15.2 Content-Length

- 엔터티 본문의 크기 (인코딩 후 기준)
- **필요성**: 메시지 경계 파악, 잘림 검출, 지속 커넥션 유지

💡 **문제**: Content-Length 없으면 → 클라이언트는 전송 중 끊김인지 정상 종료인지 구분 불가

➡️ 특히 프록시 캐시에서 잘린 콘텐츠를 저장하고 계속 제공할 위험 있음

### 본문 길이 판별 규칙

1. HEAD 같은 본문 없는 요청 → Content-Length 무시
2. `Transfer-Encoding` 존재 시 → 청크 인코딩(0-바이트 청크로 종료)
3. 둘 다 있으면 → **Transfer-Encoding 우선**
4. 멀티파트(byteranges)는 자체적으로 크기 정의
5. 그 외 → 커넥션 종료로 본문 끝 판단

---

## 15.4 미디어 타입 & Charset

- **Content-Type**: 엔터티의 형식 지정 (MIME 타입)
  - `text/html`, `image/jpeg`, `application/json` 등
- **charset**: 텍스트 매체의 문자 인코딩 지정
  - 예: `Content-Type: text/html; charset=utf-8`

### 멀티파트 타입

- 여러 데이터 파트를 포함할 수 있음
- 대표적 활용:
  - **폼 제출** (multipart/form-data)
  - **범위 응답** (multipart/byteranges)

---

## 15.5 콘텐츠 인코딩 (Content-Encoding)

**목적**: 압축 또는 암호화 → 네트워크 효율 & 보안

- 서버/프록시가 본문을 인코딩
- 수신 측이 Content-Encoding 헤더를 보고 디코딩

### 인코딩 유형

- **gzip**: 가장 널리 쓰이는 무손실 압축
- **compress, deflate**: 다른 무손실 압축 방식
- **identity**: 인코딩 없음

### Accept-Encoding

- 클라이언트가 지원하는 인코딩 리스트 전달
- Q값(0.0~1.0)으로 선호도 표시 가능
  ```
  Accept-Encoding: gzip;q=1.0, identity;q=0.5, *;q=0
  ```

---

## 15.6 전송 인코딩 (Transfer-Encoding)

- 콘텐츠 인코딩은 **데이터 자체**와 관련
- 전송 인코딩은 **메시지 구조**와 관련

### 청크 인코딩 (Chunked)

- HTTP/1.1에서 표준화된 유일한 전송 인코딩
- 본문을 여러 청크로 쪼개 전송
- `마지막에 "크기 0 청크"로 끝 표시`
- 장점: 본문 길이를 사전에 몰라도 전송 가능 → 동적 콘텐츠에 적합

---

## 15.7 시간에 따라 변하는 인스턴스

- 같은 URL이라도 시점에 따라 다른 버전이 존재
- 인스턴스 조작: **범위 요청, 델타 인코딩** 등

---

## 15.8 검사기와 신선도 (Validators & Freshness)

### 신선도

- **Expires**: 특정 시각까지 신선
- **Cache-Control: max-age**: 문서가 서버를 떠난 시점부터 유효한 시간 (더 권장)

### 조건부 요청

- 캐시 사본이 최신인지 확인 후 필요할 때만 새 사본 요청
- 예:
  ```
  If-Modified-Since: Sat, 29 Jun 2002, 14:30:00 GMT
  ```
- 검사기(validator): `Last-Modified`, `ETag` 등이 활용됨

---

## 15.9 범위 요청 (Range Requests)

- 클라이언트가 문서의 일부만 요청 가능
- 예:
  ```
  Range: bytes=4000-
  ```
- 활용: 대용량 다운로드 재개, 스트리밍 등

---

## 15.10 델타 인코딩 (Delta Encoding)

- 클라이언트가 가진 캐시 사본과 최신본의 **차이(delta)** 만 전송
- 장점: 대역폭 절약
- 단점: 서버가 과거 사본들을 보관해야 하므로 구현 부담 큼
