# 11장. 클라이언트 식별과 쿠키

## 11.1 개별 접촉

- HTTP는 익명으로 사용하며 상태가 없고 요청과 응답으로 통신하는 프로토콜
- 웹 서버는 요청을 보낸 사용자를 식별하거나 방문자가 보낸 요청을 추적하기 위해 약간의 정보를 이용할 수 있다.

#### 개인화된 서비스들

- 개별 인사: 사용자에게 특화된 환영 메시지나 페이지 내용
- 사용자 맞춤 추천: 고객의 취향에 맞는 제품 추천
- 저장된 사용자 정보: 온라인 쇼핑 사이트에서 사용자의 주소와 신용카드 정보등을 저장
- 세션 추적
  - HTTP 트랜잭션은 연결 자체에 대한 상태가 없으며 매 요청 및 응답은 일회성이고 독립적으로 일어난다.
  - 사용자가 사이트와 상호작용하려면 웹 사이트는 HTTP 트랜잭션을 식별할 방법이 필요하다.

이 장에서는 HTTP가 사용자를 식별하는 데 사용하는 기술들을 논의한다.

- 사용자 식별 관련 정보를 전달하는 HTTP 헤더들
- 클라이언트 IP 주소 추적으로 알아낸 IP주소로 사용자 식별
- 사용자 로그인 인증을 통한 식별
- URL에 식별자를 포함하는 기술인 뚱뚱한(fat) URL
- 식별 정보를 지속해서 유지하는 쿠키

## 11.2 HTTP 헤더

#### 사용자에 대한 정보를 전달하는 HTTP 헤더

- From
  - 헤더 타입: 요청
  - 설명: 사용자의 이메일 주소
  - 악의적인 서버가 이메일 주소를 모아서 스팸 메일을 발송할 수 있어서 From 헤더를 보내는 브라우저는 많지 않다.
- User-Agent
  - 헤더 타입: 요청
  - 설명: 사용자의 브라우저의 이름과 버전 정보, 운영체제 등을 포함
  - 크로스 브라우징에는 유용하나, 특정 사용자를 식별하는 데는 큰 도움이 되지 않는다.
- Referer
  - 헤더 타입: 요청
  - 설명: 사용자를 현재 페이지로 유입하게 한 URL
  - 이 헤더 자체로 사용자를 식별할 수는 없지만, 이전에 어떤 페이지를 방문했었는지 알려주어 사용자의 웹 사용 행태나 취향을 잘 파악할 수 있다.
- Authorization
  - 헤더 타입: 요청
  - 설명: 사용자의 이름과 비밀번호(뒤에서 다룸)
- Client-ip
  - 헤더 타입: 확장(요청)
  - 설명: 클라이언트의 IP 주소(뒤에서 다룸)
- X-Forwarded-For
  - 헤더 타입: 확장(요청)
  - 설명: 클라이언트의 IP 주소(뒤에서 다룸)
- Cookie
  - 헤더 타입: 확장(요청)
  - 설명: 서버가 생성한 ID 라벨(뒤에서 다룸)

## 11.3 클라이언트 IP 주소

- 초기에는 사용자 식별에 클라이언트 IP 주소를 사용하려고 했다.

  - 사용자가 확실한 IP 주소를 갖고, 주소가 바뀌지 않고, 웹 서버가 요청마다 IP를 알 수 있다면 문제없이 동작함.

- 클라이언트 IP 주소는 보통 헤더에 없지만 웹 서버는 HTTP 요청 반대쪽 TCP 커넥션의 IP 주소를 알아낼 수 있다.
- 그러나, 약점이 존재한다.
  - 클라이언트 IP 주소는 사용자가 아닌 사용하는 컴퓨터를 가리키므로, 여러 사용자가 같은 컴퓨터를 사용한다면 식별할 수 없다.
  - 인터넷 서비스 제공자(ISP)는 사용자 로그인시 동적으로 IP 주소를 할당하기 때문에 웹 서버는 사용자를 식별할 수 없다.
  - 보안 강화를 위해 네트워크 주소 변환 방화벽(NAT)를 통해 인터넷을 사용하면, 클라이언트 IP 주소를 내부에서 사용하는 하나의 방화벽 IP 주소로 변환한다.
  - HTTP 프락시와 게이트웨이는 원 서버에 새로운 TCP 연결을 하기 때문에 웹 서버는 프락시 서버의 IP 주소를 본다.
    - 일부 프락시는 Client-ip, X-Forwarded-For HTTP 같은 확장 헤더로 문제를 해결

## 11.4 사용자 로그인

#### 개념

IP 주소로 사용자를 식별하는 수동적인 방식보다, 웹 서버는 사용자 이름과 비밀번호로 인증을 요구해서 사용자에게 명시적으로 식별 요청을 할 수 있다.

#### 주요 특징

WWW-Authenticate와 Authorization 헤더

- 웹 서버는 사용자에게 사용자 이름을 묻는다는 지시적인 체계를 가지고 있다.
- 한번 로그인하면, 브라우저는 사이트로 보내는 모든 요청에 이 로그인 정보를 함께 보내므로 웹 서버는 그 로그인 정보를 항상 확인할 수 있다.

#### HTTP 인증 과정

- 최초 요청: 브라우저가 www.joes-hardware.com 사이트로 요청한다.
- 인증 요구: 서버는 사용자의 식별정보를 얻고 싶어하고, 서버는 401 Login Required HTTP 응답 코드와 WWW-Authenticate 헤더를 반환하여 로그인하라고 요청한다.
- 사용자 인증: 사용자가 사용자 이름과 비밀번호를 입력하고 브라우저는 기존 요청을 다시 보내 사용자 식별을 시도한다.
- 성공적 로그인: 이제 서버는 사용자의 식별정보를 안다
- 지속적 인증: 이 시점 이후의 요청에 대해서, 브라우저는 서버에서 오는 식별 요청에 대해 자동으로 사용자 이름, 비밀번호를 포함한다.

## 11.5 뚱뚱한 URL

어떤 웹 사이트는 사용자가 사이트를 돌아다니면, URL의 처음이나 끝에 사용자의 상태 정보를 추가한 하이퍼링크를 동적으로 생성하여 사용자를 식별한다. 이를 뚱뚱한 URL이라고 한다.

#### 문제점

- 못생긴 URL: 브라우저에 보이는 뚱뚱한 URL은 사용자에게 혼란을 준다.
- 공유하지 못하는 URL: 뚱뚱한 URL을 공유하게 되면, 개인 정보가 노출될 수 있다.
- 캐시를 사용할 수 없음: URL이 달라지므로 기존 캐시에 접근할 수 없다.
- 서버 부하 가중: 서버는 뚱뚱한 URL에 해당하는 HTML을 다시 그려야 한다.
- 이탈: 사용자가 다른 사이트로 이동하거나 해서 뚱뚱한 URL을 이탈하게 되면 지금까지의 정보들이 초기화될 것 이다.
- 세션 간 지속성의 부재: 사용자가 뚱뚱한 URL을 북마킹하지 않는 이상, 로그아웃하면 모든 정보를 잃는다.

## 11.6 쿠키

- 쿠키는 사용자를 식별하고 세션을 유지하는 방식 중 현재까지 가장 널리 사용하는 방식이다.
- 쿠키만으로 하기 힘든 일엔 앞서 설명한 기술들을 사용하기도 한다.
- 쿠키는 캐시와 충돌할 수 있어서, 대부분의 캐시나 브라우저는 쿠키 내용물을 캐싱하지 않는다.
